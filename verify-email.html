<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Email Doğrulama - Vaktim</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    
    .container {
      background: white;
      border-radius: 16px;
      padding: 40px;
      max-width: 500px;
      width: 100%;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      text-align: center;
    }
    
    .spinner {
      width: 60px;
      height: 60px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid #2563eb;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 24px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .icon {
      width: 80px;
      height: 80px;
      margin: 0 auto 24px;
      display: none;
    }
    
    .icon.success {
      background: #10B981;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .icon.error {
      background: #ef4444;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .icon svg {
      width: 48px;
      height: 48px;
      stroke: white;
      stroke-width: 3;
      fill: none;
    }
    
    h1 {
      color: #1a1a2e;
      font-size: 28px;
      margin-bottom: 12px;
    }
    
    p {
      color: #666;
      font-size: 16px;
      line-height: 1.6;
      margin-bottom: 32px;
    }
    
    .button {
      display: inline-block;
      background: #2563eb;
      color: white;
      text-decoration: none;
      padding: 14px 32px;
      border-radius: 8px;
      font-weight: 600;
      font-size: 16px;
      transition: background 0.3s;
      border: none;
      cursor: pointer;
    }
    
    .button:hover {
      background: #1d4ed8;
    }
    
    .button.secondary {
      background: #6b7280;
      margin-left: 12px;
    }
    
    .button.secondary:hover {
      background: #4b5563;
    }
    
    .fallback {
      margin-top: 20px;
      font-size: 14px;
      color: #999;
    }
    
    .fallback a {
      color: #2563eb;
      text-decoration: none;
    }
    
    #content {
      min-height: 200px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div id="content">
      <div class="spinner" id="spinner"></div>
      <h1 id="title">Email Doğrulanıyor...</h1>
      <p id="message">Lütfen bekleyin.</p>
    </div>
  </div>
  
  <script>
    // Configuration
    const EDGE_FUNCTION_URL = 'https://gercipqmupxuvyhsvqyo.supabase.co/functions/v1/verify-email-token';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdlcmNpcHFtdXB4dXZ5aHN2cXlvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzcyMDczMDIsImV4cCI6MjA1Mjc4MzMwMn0.f3b4886be950e9a1fb4497d4f9de30161fb1a9c7573bcf33a026c1e6c0e2e7f4';
    const APP_SCHEME = 'vaktim://?emailVerified=true';
    
    // Get token from URL
    const urlParams = new URLSearchParams(window.location.search);
    const token = urlParams.get('token');
    
    // Elements
    const spinner = document.getElementById('spinner');
    const title = document.getElementById('title');
    const message = document.getElementById('message');
    const content = document.getElementById('content');
    
    function showSuccess() {
      spinner.style.display = 'none';
      content.innerHTML = `
        <div class="icon success">
          <svg viewBox="0 0 24 24">
            <path d="M20 6L9 17l-5-5" />
          </svg>
        </div>
        <h1>Email Doğrulandı!</h1>
        <p>Hesabınız başarıyla aktifleştirildi. Artık tüm özelliklere erişebilirsiniz.</p>
        <button class="button" onclick="openApp()">Uygulamayı Aç</button>
        <p class="fallback">Uygulamanız yoksa <a href="https://vaktim.app">buradan indirebilirsiniz</a></p>
      `;
      
      // Try to open app automatically
      setTimeout(() => {
        tryOpenApp();
      }, 500);
    }
    
    function tryOpenApp() {
      // Try to open app with custom scheme
      window.location.href = APP_SCHEME;
      
      // If app didn't open after 2 seconds, assume it's not installed
      // (User will see the "Download" fallback link)
    }
    
    function showError(errorMessage) {
      spinner.style.display = 'none';
      content.innerHTML = `
        <div class="icon error">
          <svg viewBox="0 0 24 24">
            <path d="M18 6L6 18M6 6l12 12" />
          </svg>
        </div>
        <h1>Doğrulama Başarısız</h1>
        <p>${errorMessage}</p>
        <button class="button secondary" onclick="window.location.href='https://vaktim.app'">Ana Sayfaya Dön</button>
      `;
    }
    
    function openApp() {
      window.location.href = APP_SCHEME;
    }
    
    // Main verification logic
    async function verifyEmail() {
      if (!token) {
        showError('Doğrulama kodu bulunamadı. Lütfen email\'inizdeki linke tekrar tıklayın.');
        return;
      }
      
      try {
        const response = await fetch(`${EDGE_FUNCTION_URL}?token=${encodeURIComponent(token)}`, {
          headers: {
            'apikey': SUPABASE_ANON_KEY,
            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
          }
        });
        
        // Edge Function returns HTML, but we check status code
        if (response.ok) {
          showSuccess();
        } else {
          // Try to extract error message from response
          const text = await response.text();
          
          if (response.status === 404) {
            showError('Doğrulama linki geçersiz veya kullanılmış. Lütfen yeni bir link isteyin.');
          } else if (response.status === 410) {
            showError('Doğrulama linkinin süresi dolmuş. Lütfen uygulamadan yeni bir link isteyin.');
          } else if (response.status === 400) {
            showError('Bu doğrulama linki daha önce kullanılmış.');
          } else {
            showError('Doğrulama sırasında bir hata oluştu. Lütfen daha sonra tekrar deneyin.');
          }
        }
      } catch (error) {
        console.error('Verification error:', error);
        showError('Bağlantı hatası. Lütfen internet bağlantınızı kontrol edip tekrar deneyin.');
      }
    }
    
    // Start verification when page loads
    verifyEmail();
  </script>
</body>
</html>
